<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.demo.test.Test">
    <select id="/data/api/indoor/weighted_score/audit">
        select dataGranularityFirst,
               orderFirst,
               dataGranularitySecond,
               orderSecond,
               dataGranularityThird,
               orderThird,
               siteNum,
               stockSiteNum,
               stockSiteRate,
               stockScoringThreshold,
               stockPassAuditSiteNum,
               notVertNewStockSiteNum,
               notVertNewStockSpeGuaSiteNum,
               notVertNewStockScoringThreshold,
               notVertNewStockPassAuditSiteNum,
               notVertNewStockSpeGuaAndPassAuditSiteNum,
               notVertNewNewSiteNum,
               notVertNewNewSpeGuaSiteNum,
               notVertNewNewScoringThreshold,
               notVertNewNewPassAuditSiteNum,
               notVertNewNewSpeGuaAndPassAuditSiteNum,
               vertNewStockSiteNum,
               vertNewStockSpeGuaSiteNum,
               vertNewStockScoringThreshold,
               vertNewStockPassAuditSiteNum,
               vertNewStockSpeGuaAndPassAuditSiteNum,
               vertNewNewSiteNum,
               vertNewNewSpeGuaSiteNum,
               vertNewNewScoringThreshold,
               vertNewNewPassAuditSiteNum,
               vertNewNewSpeGuaAndPassAuditSiteNum,
               passAuditRatio
        from (
                 select '全国'                                                                         as dataGranularityFirst,
                        concat('1', '')                                                              as orderFirst,
                        ''                                                                           as dataGranularitySecond,
                        ''                                                                           as orderSecond,
                        ''                                                                           as dataGranularityThird,
                        ''                                                                           as orderThird,
                        groupUniqArray(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), scoring_threshold, null))             as notVertNewStockScoringThresholdArray,
                        groupUniqArray(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), scoring_threshold, null))             as vertNewStockScoringThresholdArray,
                        groupUniqArray(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), scoring_threshold, null))             as notVertNewNewScoringThresholdArray,
                        groupUniqArray(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), scoring_threshold, null))             as vertNewNewScoringThresholdArray,
                        groupUniqArray(if(built_state == '9', scoring_threshold, null))             as stockScoringThresholdArray,
                        count(1)                                                                     as siteNum,
                        count(if(built_state == '9', 1, null))                                       as stockSiteNum,
                        intDivOrZero(toDecimal64(stockSiteNum, 2) * 100, toDecimal64(siteNum, 2))    as stockSiteRate,
                        if(length(stockScoringThresholdArray) > 1, null,stockScoringThresholdArray[1]) as stockScoringThreshold,
                        count(if(and(built_state == '9', is_high_value_by_score == '1'), 1, null)) as stockPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), 1, null)) as notVertNewStockSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10', spe_gua <![CDATA[ <> ]]> ''), 1, null)) as notVertNewStockSpeGuaSiteNum,
                        if(length(notVertNewStockScoringThresholdArray) > 1, null,notVertNewStockScoringThresholdArray[1]) as notVertNewStockScoringThreshold,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1'), 1,null)) as notVertNewStockPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as notVertNewStockSpeGuaAndPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), 1,null))                                                              as notVertNewNewSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as notVertNewNewSpeGuaSiteNum,
                        if(length(notVertNewNewScoringThresholdArray) > 1, null,notVertNewNewScoringThresholdArray[1]) as notVertNewNewScoringThreshold,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1'), 1,null)) as notVertNewNewPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null))                                                              as notVertNewNewSpeGuaAndPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), 1,null)) as vertNewStockSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewStockSpeGuaSiteNum,
                        if(length(vertNewStockScoringThresholdArray) > 1, null,vertNewStockScoringThresholdArray[1])   as vertNewStockScoringThreshold,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1'), 1,null)) as vertNewStockPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewStockSpeGuaAndPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), 1,null)) as vertNewNewSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewNewSpeGuaSiteNum,
                        if(length(vertNewNewScoringThresholdArray) > 1, null,vertNewNewScoringThresholdArray[1]) as vertNewNewScoringThreshold,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1'), 1,null)) as vertNewNewPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewNewSpeGuaAndPassAuditSiteNum,
                        intDivOrZero(toDecimal64(count(if(is_high_value_by_score == '1', 1, null)), 2) * 100,toDecimal64(siteNum, 2)) as passAuditRatio
                 from cmdi_pvopp.ads_indoor_weighted_score_for_annual_plan_info
                 where event_id = #{params.raw.id}
                 having siteNum > 0
                 union all
                 select '全国'                                                                         as dataGranularityFirst,
                        concat('1', '')                                                              as orderFirst,
                        <choose>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">area_type</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">area_type</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">building_site_secondary_cover_scene</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">building_site_secondary_cover_scene</when>
                        </choose> as dataGranularitySecond,
                        <choose>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">concat('1', area_type)</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">concat('1', area_type)</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">concat('1', building_site_secondary_cover_scene)</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">concat('1', building_site_secondary_cover_scene)</when>
                        </choose> as orderSecond,
                        ''                                                                           as dataGranularityThird,
                        ''                                                                           as orderThird,
                        groupUniqArray(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), scoring_threshold, null))             as notVertNewStockScoringThresholdArray,
                        groupUniqArray(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), scoring_threshold, null))             as vertNewStockScoringThresholdArray,
                        groupUniqArray(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), scoring_threshold, null))             as notVertNewNewScoringThresholdArray,
                        groupUniqArray(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), scoring_threshold, null))             as vertNewNewScoringThresholdArray,
                        groupUniqArray(if(built_state == '9', scoring_threshold, null))             as stockScoringThresholdArray,
                        count(1)                                                                     as siteNum,
                        count(if(built_state == '9', 1, null))                                       as stockSiteNum,
                        intDivOrZero(toDecimal64(stockSiteNum, 2) * 100, toDecimal64(siteNum, 2))    as stockSiteRate,
                        if(length(stockScoringThresholdArray) > 1, null,stockScoringThresholdArray[1]) as stockScoringThreshold,
                        count(if(and(built_state == '9', is_high_value_by_score == '1'), 1, null)) as stockPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), 1, null)) as notVertNewStockSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10', spe_gua <![CDATA[ <> ]]> ''), 1, null)) as notVertNewStockSpeGuaSiteNum,
                        if(length(notVertNewStockScoringThresholdArray) > 1, null,notVertNewStockScoringThresholdArray[1]) as notVertNewStockScoringThreshold,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1'), 1,null)) as notVertNewStockPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as notVertNewStockSpeGuaAndPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), 1,null))                                                              as notVertNewNewSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as notVertNewNewSpeGuaSiteNum,
                        if(length(notVertNewNewScoringThresholdArray) > 1, null,notVertNewNewScoringThresholdArray[1]) as notVertNewNewScoringThreshold,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1'), 1,null)) as notVertNewNewPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null))                                                              as notVertNewNewSpeGuaAndPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), 1,null)) as vertNewStockSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewStockSpeGuaSiteNum,
                        if(length(vertNewStockScoringThresholdArray) > 1, null,vertNewStockScoringThresholdArray[1])   as vertNewStockScoringThreshold,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1'), 1,null)) as vertNewStockPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewStockSpeGuaAndPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), 1,null)) as vertNewNewSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewNewSpeGuaSiteNum,
                        if(length(vertNewNewScoringThresholdArray) > 1, null,vertNewNewScoringThresholdArray[1]) as vertNewNewScoringThreshold,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1'), 1,null)) as vertNewNewPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewNewSpeGuaAndPassAuditSiteNum,
                        intDivOrZero(toDecimal64(count(if(is_high_value_by_score == '1', 1, null)), 2) * 100,toDecimal64(siteNum, 2)) as passAuditRatio

                 from cmdi_pvopp.ads_indoor_weighted_score_for_annual_plan_info
                 where event_id = #{params.raw.id}
                 group by
                <choose>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">area_type</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">area_type</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">building_site_secondary_cover_scene</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">building_site_secondary_cover_scene</when>
                </choose>
                 union all
                 select province_type                                                                as dataGranularityFirst,
                        concat('2', multiIf(
                                province_type = '一类', '1',
                                province_type = '二类', '2',
                                province_type = '三类', '3',
                                province_type = '四类', '4',
                                province_type = '五类', '5',
                                province_type = '六类', '6', '7'))                                     as orderFirst,
                        ''                                                                           as dataGranularitySecond,
                        ''                                                                           as orderSecond,
                        ''                                                                           as dataGranularityThird,
                        ''                                                                           as orderThird,
                        groupUniqArray(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), scoring_threshold, null))             as notVertNewStockScoringThresholdArray,
                        groupUniqArray(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), scoring_threshold, null))             as vertNewStockScoringThresholdArray,
                        groupUniqArray(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), scoring_threshold, null))             as notVertNewNewScoringThresholdArray,
                        groupUniqArray(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), scoring_threshold, null))             as vertNewNewScoringThresholdArray,
                        groupUniqArray(if(built_state == '9', scoring_threshold, null))             as stockScoringThresholdArray,
                        count(1)                                                                     as siteNum,
                        count(if(built_state == '9', 1, null))                                       as stockSiteNum,
                        intDivOrZero(toDecimal64(stockSiteNum, 2) * 100, toDecimal64(siteNum, 2))    as stockSiteRate,
                        if(length(stockScoringThresholdArray) > 1, null,stockScoringThresholdArray[1]) as stockScoringThreshold,
                        count(if(and(built_state == '9', is_high_value_by_score == '1'), 1, null)) as stockPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), 1, null)) as notVertNewStockSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10', spe_gua <![CDATA[ <> ]]> ''), 1, null)) as notVertNewStockSpeGuaSiteNum,
                        if(length(notVertNewStockScoringThresholdArray) > 1, null,notVertNewStockScoringThresholdArray[1]) as notVertNewStockScoringThreshold,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1'), 1,null)) as notVertNewStockPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as notVertNewStockSpeGuaAndPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), 1,null))                                                              as notVertNewNewSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as notVertNewNewSpeGuaSiteNum,
                        if(length(notVertNewNewScoringThresholdArray) > 1, null,notVertNewNewScoringThresholdArray[1]) as notVertNewNewScoringThreshold,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1'), 1,null)) as notVertNewNewPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null))                                                              as notVertNewNewSpeGuaAndPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), 1,null)) as vertNewStockSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewStockSpeGuaSiteNum,
                        if(length(vertNewStockScoringThresholdArray) > 1, null,vertNewStockScoringThresholdArray[1])   as vertNewStockScoringThreshold,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1'), 1,null)) as vertNewStockPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewStockSpeGuaAndPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), 1,null)) as vertNewNewSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewNewSpeGuaSiteNum,
                        if(length(vertNewNewScoringThresholdArray) > 1, null,vertNewNewScoringThresholdArray[1]) as vertNewNewScoringThreshold,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1'), 1,null)) as vertNewNewPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewNewSpeGuaAndPassAuditSiteNum,
                        intDivOrZero(toDecimal64(count(if(is_high_value_by_score == '1', 1, null)), 2) * 100,toDecimal64(siteNum, 2)) as passAuditRatio
                 from cmdi_pvopp.ads_indoor_weighted_score_for_annual_plan_info
                 where event_id = #{params.raw.id}
                 group by province_type
                 union all
                 select province_type                                                                as dataGranularityFirst,
                        concat('2', multiIf(
                                province_type = '一类', '1',
                                province_type = '二类', '2',
                                province_type = '三类', '3',
                                province_type = '四类', '4',
                                province_type = '五类', '5',
                                province_type = '六类', '6', '7'))                                     as orderFirst,
                        <choose>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">area_type</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">area_type</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">building_site_secondary_cover_scene</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">building_site_secondary_cover_scene</when>
                        </choose> as dataGranularitySecond,
                        <choose>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">concat('1', area_type)</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">concat('1', area_type)</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">concat('1', building_site_secondary_cover_scene)</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">concat('1', building_site_secondary_cover_scene)</when>
                        </choose> as orderSecond,
                        ''                                                                           as dataGranularityThird,
                        ''                                                                           as orderThird,
                        groupUniqArray(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), scoring_threshold, null))             as notVertNewStockScoringThresholdArray,
                        groupUniqArray(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), scoring_threshold, null))             as vertNewStockScoringThresholdArray,
                        groupUniqArray(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), scoring_threshold, null))             as notVertNewNewScoringThresholdArray,
                        groupUniqArray(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), scoring_threshold, null))             as vertNewNewScoringThresholdArray,
                        groupUniqArray(if(built_state == '9', scoring_threshold, null))             as stockScoringThresholdArray,
                        count(1)                                                                     as siteNum,
                        count(if(built_state == '9', 1, null))                                       as stockSiteNum,
                        intDivOrZero(toDecimal64(stockSiteNum, 2) * 100, toDecimal64(siteNum, 2))    as stockSiteRate,
                        if(length(stockScoringThresholdArray) > 1, null,stockScoringThresholdArray[1]) as stockScoringThreshold,
                        count(if(and(built_state == '9', is_high_value_by_score == '1'), 1, null)) as stockPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), 1, null)) as notVertNewStockSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10', spe_gua <![CDATA[ <> ]]> ''), 1, null)) as notVertNewStockSpeGuaSiteNum,
                        if(length(notVertNewStockScoringThresholdArray) > 1, null,notVertNewStockScoringThresholdArray[1]) as notVertNewStockScoringThreshold,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1'), 1,null)) as notVertNewStockPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as notVertNewStockSpeGuaAndPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), 1,null))                                                              as notVertNewNewSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as notVertNewNewSpeGuaSiteNum,
                        if(length(notVertNewNewScoringThresholdArray) > 1, null,notVertNewNewScoringThresholdArray[1]) as notVertNewNewScoringThreshold,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1'), 1,null)) as notVertNewNewPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null))                                                              as notVertNewNewSpeGuaAndPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), 1,null)) as vertNewStockSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewStockSpeGuaSiteNum,
                        if(length(vertNewStockScoringThresholdArray) > 1, null,vertNewStockScoringThresholdArray[1])   as vertNewStockScoringThreshold,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1'), 1,null)) as vertNewStockPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewStockSpeGuaAndPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), 1,null)) as vertNewNewSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewNewSpeGuaSiteNum,
                        if(length(vertNewNewScoringThresholdArray) > 1, null,vertNewNewScoringThresholdArray[1]) as vertNewNewScoringThreshold,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1'), 1,null)) as vertNewNewPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewNewSpeGuaAndPassAuditSiteNum,
                        intDivOrZero(toDecimal64(count(if(is_high_value_by_score == '1', 1, null)), 2) * 100,toDecimal64(siteNum, 2)) as passAuditRatio
                 from cmdi_pvopp.ads_indoor_weighted_score_for_annual_plan_info
                 where event_id = #{params.raw.id}
                 group by province_type,
                <choose>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">area_type</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">area_type</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">building_site_secondary_cover_scene</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">building_site_secondary_cover_scene</when>
                </choose>
                 union all
                 select province_type                                                                as dataGranularityFirst,
                        concat('2', multiIf(
                                province_type = '一类', '1',
                                province_type = '二类', '2',
                                province_type = '三类', '3',
                                province_type = '四类', '4',
                                province_type = '五类', '5',
                                province_type = '六类', '6', '7'))                                     as orderFirst,
                        <choose>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">province_name</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">citys_name</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">province_name</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">citys_name</when>
                        </choose> as dataGranularitySecond,
                        <choose>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">concat('2', any(toString(province_order)))</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">concat('2', any(toString(citys_order)))</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">concat('2', any(toString(province_order)))</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">concat('2', any(toString(citys_order)))</when>
                        </choose> as orderSecond,
                        ''                                                                           as dataGranularityThird,
                        ''                                                                           as orderThird,
                        groupUniqArray(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), scoring_threshold, null))             as notVertNewStockScoringThresholdArray,
                        groupUniqArray(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), scoring_threshold, null))             as vertNewStockScoringThresholdArray,
                        groupUniqArray(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), scoring_threshold, null))             as notVertNewNewScoringThresholdArray,
                        groupUniqArray(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), scoring_threshold, null))             as vertNewNewScoringThresholdArray,
                        groupUniqArray(if(built_state == '9', scoring_threshold, null))             as stockScoringThresholdArray,
                        count(1)                                                                     as siteNum,
                        count(if(built_state == '9', 1, null))                                       as stockSiteNum,
                        intDivOrZero(toDecimal64(stockSiteNum, 2) * 100, toDecimal64(siteNum, 2))    as stockSiteRate,
                        if(length(stockScoringThresholdArray) > 1, null,stockScoringThresholdArray[1]) as stockScoringThreshold,
                        count(if(and(built_state == '9', is_high_value_by_score == '1'), 1, null)) as stockPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), 1, null)) as notVertNewStockSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10', spe_gua <![CDATA[ <> ]]> ''), 1, null)) as notVertNewStockSpeGuaSiteNum,
                        if(length(notVertNewStockScoringThresholdArray) > 1, null,notVertNewStockScoringThresholdArray[1]) as notVertNewStockScoringThreshold,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1'), 1,null)) as notVertNewStockPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as notVertNewStockSpeGuaAndPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), 1,null))                                                              as notVertNewNewSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as notVertNewNewSpeGuaSiteNum,
                        if(length(notVertNewNewScoringThresholdArray) > 1, null,notVertNewNewScoringThresholdArray[1]) as notVertNewNewScoringThreshold,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1'), 1,null)) as notVertNewNewPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null))                                                              as notVertNewNewSpeGuaAndPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), 1,null)) as vertNewStockSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewStockSpeGuaSiteNum,
                        if(length(vertNewStockScoringThresholdArray) > 1, null,vertNewStockScoringThresholdArray[1])   as vertNewStockScoringThreshold,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1'), 1,null)) as vertNewStockPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewStockSpeGuaAndPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), 1,null)) as vertNewNewSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewNewSpeGuaSiteNum,
                        if(length(vertNewNewScoringThresholdArray) > 1, null,vertNewNewScoringThresholdArray[1]) as vertNewNewScoringThreshold,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1'), 1,null)) as vertNewNewPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewNewSpeGuaAndPassAuditSiteNum,
                        intDivOrZero(toDecimal64(count(if(is_high_value_by_score == '1', 1, null)), 2) * 100,toDecimal64(siteNum, 2)) as passAuditRatio
                 from cmdi_pvopp.ads_indoor_weighted_score_for_annual_plan_info
                 where event_id = #{params.raw.id}
                 group by province_type,
                <choose>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">province_name</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">citys_name</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">province_name</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">citys_name</when>
                </choose>
                 union all
                 select province_type                                                                as dataGranularityFirst,
                        concat('2', multiIf(
                                province_type = '一类', '1',
                                province_type = '二类', '2',
                                province_type = '三类', '3',
                                province_type = '四类', '4',
                                province_type = '五类', '5',
                                province_type = '六类', '6', '7'))                                     as orderFirst,
                        <choose>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">province_name</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">citys_name</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">province_name</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">citys_name</when>
                        </choose> as dataGranularitySecond,
                        <choose>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">concat('2', any(toString(province_order)))</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">concat('2', any(toString(citys_order)))</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">concat('2', any(toString(province_order)))</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">concat('2', any(toString(citys_order)))</when>
                        </choose> as orderSecond,
                        <choose>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">area_type</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">area_type</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">building_site_secondary_cover_scene</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">building_site_secondary_cover_scene</when>
                        </choose> as dataGranularityThird,
                        <choose>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">concat('1', area_type)</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">concat('1', area_type)</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">concat('1', building_site_secondary_cover_scene)</when>
                            <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">concat('1', building_site_secondary_cover_scene)</when>
                        </choose> as orderThird,
                        groupUniqArray(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), scoring_threshold, null))             as notVertNewStockScoringThresholdArray,
                        groupUniqArray(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), scoring_threshold, null))             as vertNewStockScoringThresholdArray,
                        groupUniqArray(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), scoring_threshold, null))             as notVertNewNewScoringThresholdArray,
                        groupUniqArray(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), scoring_threshold, null))             as vertNewNewScoringThresholdArray,
                        groupUniqArray(if(built_state == '9', scoring_threshold, null))             as stockScoringThresholdArray,
                        count(1)                                                                     as siteNum,
                        count(if(built_state == '9', 1, null))                                       as stockSiteNum,
                        intDivOrZero(toDecimal64(stockSiteNum, 2) * 100, toDecimal64(siteNum, 2))    as stockSiteRate,
                        if(length(stockScoringThresholdArray) > 1, null,stockScoringThresholdArray[1]) as stockScoringThreshold,
                        count(if(and(built_state == '9', is_high_value_by_score == '1'), 1, null)) as stockPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), 1, null)) as notVertNewStockSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10', spe_gua <![CDATA[ <> ]]> ''), 1, null)) as notVertNewStockSpeGuaSiteNum,
                        if(length(notVertNewStockScoringThresholdArray) > 1, null,notVertNewStockScoringThresholdArray[1]) as notVertNewStockScoringThreshold,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1'), 1,null)) as notVertNewStockPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as notVertNewStockSpeGuaAndPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), 1,null))                                                              as notVertNewNewSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as notVertNewNewSpeGuaSiteNum,
                        if(length(notVertNewNewScoringThresholdArray) > 1, null,notVertNewNewScoringThresholdArray[1]) as notVertNewNewScoringThreshold,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1'), 1,null)) as notVertNewNewPassAuditSiteNum,
                        count(if(and(not and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null))                                                              as notVertNewNewSpeGuaAndPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10'), 1,null)) as vertNewStockSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewStockSpeGuaSiteNum,
                        if(length(vertNewStockScoringThresholdArray) > 1, null,vertNewStockScoringThresholdArray[1])   as vertNewStockScoringThreshold,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1'), 1,null)) as vertNewStockPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '10',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewStockSpeGuaAndPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11'), 1,null)) as vertNewNewSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewNewSpeGuaSiteNum,
                        if(length(vertNewNewScoringThresholdArray) > 1, null,vertNewNewScoringThresholdArray[1]) as vertNewNewScoringThreshold,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1'), 1,null)) as vertNewNewPassAuditSiteNum,
                        count(if(and(and(isNotNull(vert_ind_dem), vert_ind_dem <![CDATA[ <> ]]> ''), built_state == '11',is_high_value_by_score == '1', spe_gua <![CDATA[ <> ]]> ''), 1,null)) as vertNewNewSpeGuaAndPassAuditSiteNum,
                        intDivOrZero(toDecimal64(count(if(is_high_value_by_score == '1', 1, null)), 2) * 100,toDecimal64(siteNum, 2)) as passAuditRatio
                 from cmdi_pvopp.ads_indoor_weighted_score_for_annual_plan_info
                 where event_id = #{params.raw.id}
                 group by province_type,
                <choose>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">province_name</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">citys_name</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">province_name</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">citys_name</when>
                </choose>,
                <choose>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '1'.toString() ">area_type</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '2'.toString() ">area_type</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '3'.toString() ">building_site_secondary_cover_scene</when>
                    <when test="params.raw.dataGranularityType !=null and params.raw.dataGranularityType == '4'.toString() ">building_site_secondary_cover_scene</when>
                </choose>
                 ) a1
        order by a1.orderFirst, a1.orderSecond, a1.orderThird
    </select>
</mapper>